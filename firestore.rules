rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour les utilisateurs - un utilisateur peut lire/écrire ses propres données
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour les progressions - un utilisateur peut gérer ses propres progressions
    match /progressions/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour les documents imbriqués de progressions
    match /progressions/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour les statuts de cours - un utilisateur peut gérer ses propres statuts
    match /course_status/{document} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Règles pour les données publiques (cours, QCM, etc.) - lecture pour tous les utilisateurs authentifiés
    match /courses/{document} {
      allow read: if request.auth != null;
    }
    
    match /qcm/{document} {
      allow read: if request.auth != null;
    }
    
    match /subjects/{document} {
      allow read: if request.auth != null;
    }
    
    // Règles pour les favoris et suggestions - un utilisateur peut gérer ses propres données
    match /user_favorites/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /user_suggestions/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour les groupes de favoris
    match /course_groups/{document} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Règles pour les programmes générés par IA - lecture pour tous les utilisateurs authentifiés, écriture pour l'application
    match /programme/{document} {
      allow read: if request.auth != null;
      allow write, create: if request.auth != null;
    }
    
    match /programme_matiere/{document} {
      allow read: if request.auth != null;
      allow write, create: if request.auth != null;
    }
    
    // Règles pour les cours générés - lecture pour tous les utilisateurs authentifiés
    match /generated_courses/{document} {
      allow read: if request.auth != null;
      allow write, create: if request.auth != null;
    }
    
    // Règles par défaut - refuser tout accès non spécifié
    match /{document=**} {
      allow read, write: if false;
    }
  }
}